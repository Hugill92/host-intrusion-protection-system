[CmdletBinding()]
param(
    [ValidateSet("DEV","LIVE")]
    [string]$Mode = "DEV",
    [string]$RunStamp
)

Set-StrictMode -Version Latest
$ErrorActionPreference = "Stop"

$FirewallRoot = "C:\FirewallInstaller\Firewall"
$TestId = "PT-04-SilentFailureNotify"

function EnsureDir($p){ if(-not (Test-Path $p)){ New-Item $p -ItemType Directory -Force | Out-Null } }
function Now { (Get-Date).ToString("o") }

# Logs
$logDir = Join-Path $FirewallRoot "Logs\Pentest\$TestId"
EnsureDir $logDir
$logPath = Join-Path $logDir ("pentest_{0}.log" -f $RunStamp)
Start-Transcript -Path $logPath -Force | Out-Null

# Results
$state = Join-Path $FirewallRoot "State\Pentest\$TestId"
$resultsDir = Join-Path $state "results"
EnsureDir $resultsDir
$out = Join-Path $resultsDir ("pentest-results_{0}.json" -f $RunStamp)

Import-Module "$FirewallRoot\Modules\FirewallNotifications.psm1" -Force

function Notify($sev,$title,$msg){
    Send-FirewallNotification -Severity $sev -Title $title -Message $msg -Notify @("Popup","Event") -TestId $TestId
}

$queue = Join-Path $FirewallRoot "State\NotifyQueue\Pending"
EnsureDir $queue

$start = Now
$resultObj = @{
    TestId=$TestId
    RunStamp=$RunStamp
    Mode=$Mode
    Category="Pentest"
    Controlled=$true
    StartTime=$start
    EndTime=$null
    Status=$null
    ExitCode=$null
    Evidence=@{}
    Actions=@{}
    Notifications=@{ ToastRequested=$true; EventRequested=$true }
    Artifacts=@{ Log=$logPath; Result=$out }
}

try {
    if ($Mode -ne "LIVE") {
        $resultObj.Status="SKIPPED"
        $resultObj.ExitCode=0
        $resultObj.EndTime=Now
        $resultObj | ConvertTo-Json -Depth 12 | Set-Content -Path $out -Encoding UTF8
        Stop-Transcript | Out-Null
        exit 0
    }

    # enqueue
    Notify "Critical" "PenTest: notifier drain check" "This is a controlled pentest. Pending queue should drain quickly if notifier is healthy."

    $timeoutSec = 25
    $startWait = Get-Date
    $pendingCounts = @()

    while (((Get-Date) - $startWait).TotalSeconds -lt $timeoutSec) {
        $c = (Get-ChildItem $queue -Filter *.json -ErrorAction SilentlyContinue | Measure-Object).Count
        $pendingCounts += $c
        if ($c -eq 0) { break }
        Start-Sleep -Milliseconds 500
    }

    $finalPending = (Get-ChildItem $queue -Filter *.json -ErrorAction SilentlyContinue | Measure-Object).Count
    $healthy = ($finalPending -eq 0)

    $resultObj.Evidence = @{
        TimeoutSeconds=$timeoutSec
        PendingCountsSample=$pendingCounts
        FinalPending=$finalPending
        NotifierHealthy=$healthy
    }

    if (-not $healthy) {
        Notify "Critical" "PenTest FAIL: notifications not draining" "Controlled pentest: Pending queue is not being processed. User notifier may be down."
        $resultObj.Status="FAIL"
        $resultObj.ExitCode=2
        $resultObj.EndTime=Now
        $resultObj | ConvertTo-Json -Depth 14 | Set-Content -Path $out -Encoding UTF8
        Stop-Transcript | Out-Null
        exit 2
    }

    Notify "Critical" "PenTest PASS: notifier healthy" "Controlled pentest: Pending queue drained successfully."
    $resultObj.Status="PASS"
    $resultObj.ExitCode=0
    $resultObj.EndTime=Now
    $resultObj | ConvertTo-Json -Depth 14 | Set-Content -Path $out -Encoding UTF8
    Stop-Transcript | Out-Null
    exit 0
}
catch {
    try { Notify "Critical" "PenTest error" $_.Exception.Message } catch {}
    $resultObj.Status="FAIL"
    $resultObj.ExitCode=1
    $resultObj.EndTime=Now
    $resultObj.Evidence.Error=$_.Exception.Message
    $resultObj | ConvertTo-Json -Depth 14 | Set-Content -Path $out -Encoding UTF8
    Stop-Transcript | Out-Null
    exit 1
}

# SIG # Begin signature block
# MIIElAYJKoZIhvcNAQcCoIIEhTCCBIECAQExDzANBglghkgBZQMEAgEFADB5Bgor
# BgEEAYI3AgEEoGswaTA0BgorBgEEAYI3AgEeMCYCAwEAAAQQH8w7YFlLCE63JNLG
# KX7zUQIBAAIBAAIBAAIBAAIBADAxMA0GCWCGSAFlAwQCAQUABCAjsOCW0DjIWH6Y
# nVhd+ww3x12FcqvdENuRKjTeoAN41aCCArUwggKxMIIBmaADAgECAhQD4857cPuq
# YA1JZL+WI1Yn9crpsTANBgkqhkiG9w0BAQsFADAnMSUwIwYDVQQDDBxGaXJld2Fs
# bENvcmUgT2ZmbGluZSBSb290IENBMB4XDTI2MDIwMzA3NTU1N1oXDTI5MDMwOTA3
# NTU1N1owWDELMAkGA1UEBhMCVVMxETAPBgNVBAsMCFNlY3VyaXR5MRUwEwYDVQQK
# DAxGaXJld2FsbENvcmUxHzAdBgNVBAMMFkZpcmV3YWxsQ29yZSBTaWduYXR1cmUw
# WTATBgcqhkjOPQIBBggqhkjOPQMBBwNCAATEFkC5IO0Ns0zPmdtnHpeiy/QjGyR5
# XcfYjx8wjVhMYoyZ5gyGaXjRBAnBsRsbSL172kF3dMSv20JufNI5SmZMo28wbTAJ
# BgNVHRMEAjAAMAsGA1UdDwQEAwIHgDATBgNVHSUEDDAKBggrBgEFBQcDAzAdBgNV
# HQ4EFgQUqbvNi/eHRRZJy7n5n3zuXu/sSOwwHwYDVR0jBBgwFoAULCjMhE2sOk26
# qY28GVmu4DqwehMwDQYJKoZIhvcNAQELBQADggEBAJsvjHGxkxvAWGAH1xiR+SOb
# vLKaaqVwKme3hHAXmTathgWUjjDwHQgFohPy7Zig2Msu11zlReUCGdGu2easaECF
# dMyiKzfZIA4+MQHQWv+SMcm912OjDtwEtCjNC0/+Q1BDISPv7OA8w7TDrmLk00mS
# il/f6Z4ZNlfegdoDyeDYK8lf+9DO2ARrddRU+wYrgXcdRzhekkBs9IoJ4qfXokOv
# u2ZvVZrPE3f2IiFPbmuBgzdbJ/VdkeCoAOl+D33Qyddzk8J/z7WSDiWqISF1E7GZ
# KSjgQp8c9McTcW15Ym4MR+lbyn3+CigGOrl89lzhMymm6rj6vSbvSMml2AEQgH0x
# ggE1MIIBMQIBATA/MCcxJTAjBgNVBAMMHEZpcmV3YWxsQ29yZSBPZmZsaW5lIFJv
# b3QgQ0ECFAPjzntw+6pgDUlkv5YjVif1yumxMA0GCWCGSAFlAwQCAQUAoIGEMBgG
# CisGAQQBgjcCAQwxCjAIoAKAAKECgAAwGQYJKoZIhvcNAQkDMQwGCisGAQQBgjcC
# AQQwHAYKKwYBBAGCNwIBCzEOMAwGCisGAQQBgjcCARUwLwYJKoZIhvcNAQkEMSIE
# IOJCqQidhS2R6W/7eyMRzXhjTcgYUuhXJOuFW8mdFiofMAsGByqGSM49AgEFAARI
# MEYCIQC7zYFPOhscVnAuR7GhE04bsACl+TTBrGQU7AY9yaNzRgIhAL4huoMHeh9N
# Vtqkl29VMcSskGbxY1cxrvtin/Cs6zSh
# SIG # End signature block
