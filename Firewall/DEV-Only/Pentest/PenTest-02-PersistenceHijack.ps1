[CmdletBinding()]
param(
    [ValidateSet("DEV","LIVE")]
    [string]$Mode = "DEV",
    [string]$RunStamp
)

Set-StrictMode -Version Latest
$ErrorActionPreference = "Stop"

$FirewallRoot = "C:\FirewallInstaller\Firewall"
$TestId = "PT-02-PersistenceHijack"
$TaskName = "FirewallCore User Notifier"
$ExpectedScript = "C:\FirewallInstaller\Firewall\Monitor\Firewall-UserNotifier.ps1"

function EnsureDir($p){ if(-not (Test-Path $p)){ New-Item $p -ItemType Directory -Force | Out-Null } }
function Stamp { if($RunStamp){$RunStamp}else{(Get-Date).ToString("yyyyMMdd_HHmmss")} }
function Result([string]$s){
    $c=@{PASS="Green";FAIL="Red";SKIPPED="Yellow"}[$s]
    Write-Host "[PENTEST-RESULT] $s" -ForegroundColor $c
}
function Notify($sev,$title,$msg){
    try{
        Import-Module "$FirewallRoot\Modules\FirewallNotifications.psm1" -Force -ErrorAction Stop
        Send-FirewallNotification -Severity $sev -Title $title -Message $msg -Notify @("Popup","Event") -TestId $TestId
    } catch {}
}

$state = Join-Path $FirewallRoot "State\Pentest\$TestId"
$resultsDir = Join-Path $state "results"
EnsureDir $resultsDir
$out = Join-Path $resultsDir ("pentest-results_{0}.json" -f (Stamp))

try {
    if ($Mode -ne "LIVE") {
        @{ TestId=$TestId; Mode=$Mode; Status="SKIPPED"; Reason="LIVE-only"; Stamp=(Stamp) } |
            ConvertTo-Json -Depth 6 | Set-Content -Path $out -Encoding UTF8
        Result "SKIPPED"
        exit 0
    }

    $t = Get-ScheduledTask -TaskName $TaskName -ErrorAction Stop
    $a = $t.Actions | Select-Object -First 1

    $arg = [string]$a.Arguments
    $ok = ($arg -match [regex]::Escape($ExpectedScript))

    $payload = @{
        TestId=$TestId; Stamp=(Stamp); Mode=$Mode;
        TaskName=$TaskName; ExpectedScript=$ExpectedScript;
        ActionExecute=$a.Execute; ActionArguments=$a.Arguments;
        MatchExpected=$ok
    }

    if (-not $ok) {
        Notify "Critical" "Persistence hijack detected" ("Scheduled task action mismatch for: " + $TaskName)
        $payload.Status="FAIL"
        $payload | ConvertTo-Json -Depth 8 | Set-Content -Path $out -Encoding UTF8
        Result "FAIL"
        exit 2
    }

    $payload.Status="PASS"
    $payload | ConvertTo-Json -Depth 8 | Set-Content -Path $out -Encoding UTF8
    Result "PASS"
    exit 0
}
catch {
    Notify "Critical" "PenTest error" $_.Exception.Message
    @{ TestId=$TestId; Stamp=(Stamp); Mode=$Mode; Status="FAIL"; Error=$_.Exception.Message } |
        ConvertTo-Json -Depth 6 | Set-Content -Path $out -Encoding UTF8
    Result "FAIL"
    exit 1
}

# SIG # Begin signature block
# MIIElAYJKoZIhvcNAQcCoIIEhTCCBIECAQExDzANBglghkgBZQMEAgEFADB5Bgor
# BgEEAYI3AgEEoGswaTA0BgorBgEEAYI3AgEeMCYCAwEAAAQQH8w7YFlLCE63JNLG
# KX7zUQIBAAIBAAIBAAIBAAIBADAxMA0GCWCGSAFlAwQCAQUABCCCldzu6jP2Rfty
# 5Xq+MnLFbS23Wv9TYFzf0MzTlttUcqCCArUwggKxMIIBmaADAgECAhQD4857cPuq
# YA1JZL+WI1Yn9crpsTANBgkqhkiG9w0BAQsFADAnMSUwIwYDVQQDDBxGaXJld2Fs
# bENvcmUgT2ZmbGluZSBSb290IENBMB4XDTI2MDIwMzA3NTU1N1oXDTI5MDMwOTA3
# NTU1N1owWDELMAkGA1UEBhMCVVMxETAPBgNVBAsMCFNlY3VyaXR5MRUwEwYDVQQK
# DAxGaXJld2FsbENvcmUxHzAdBgNVBAMMFkZpcmV3YWxsQ29yZSBTaWduYXR1cmUw
# WTATBgcqhkjOPQIBBggqhkjOPQMBBwNCAATEFkC5IO0Ns0zPmdtnHpeiy/QjGyR5
# XcfYjx8wjVhMYoyZ5gyGaXjRBAnBsRsbSL172kF3dMSv20JufNI5SmZMo28wbTAJ
# BgNVHRMEAjAAMAsGA1UdDwQEAwIHgDATBgNVHSUEDDAKBggrBgEFBQcDAzAdBgNV
# HQ4EFgQUqbvNi/eHRRZJy7n5n3zuXu/sSOwwHwYDVR0jBBgwFoAULCjMhE2sOk26
# qY28GVmu4DqwehMwDQYJKoZIhvcNAQELBQADggEBAJsvjHGxkxvAWGAH1xiR+SOb
# vLKaaqVwKme3hHAXmTathgWUjjDwHQgFohPy7Zig2Msu11zlReUCGdGu2easaECF
# dMyiKzfZIA4+MQHQWv+SMcm912OjDtwEtCjNC0/+Q1BDISPv7OA8w7TDrmLk00mS
# il/f6Z4ZNlfegdoDyeDYK8lf+9DO2ARrddRU+wYrgXcdRzhekkBs9IoJ4qfXokOv
# u2ZvVZrPE3f2IiFPbmuBgzdbJ/VdkeCoAOl+D33Qyddzk8J/z7WSDiWqISF1E7GZ
# KSjgQp8c9McTcW15Ym4MR+lbyn3+CigGOrl89lzhMymm6rj6vSbvSMml2AEQgH0x
# ggE1MIIBMQIBATA/MCcxJTAjBgNVBAMMHEZpcmV3YWxsQ29yZSBPZmZsaW5lIFJv
# b3QgQ0ECFAPjzntw+6pgDUlkv5YjVif1yumxMA0GCWCGSAFlAwQCAQUAoIGEMBgG
# CisGAQQBgjcCAQwxCjAIoAKAAKECgAAwGQYJKoZIhvcNAQkDMQwGCisGAQQBgjcC
# AQQwHAYKKwYBBAGCNwIBCzEOMAwGCisGAQQBgjcCARUwLwYJKoZIhvcNAQkEMSIE
# IARqxSOwIRbtZFZQTiRJ0DOBuXrH3oNqBMCcAOe53ogmMAsGByqGSM49AgEFAARI
# MEYCIQDnC8OmboTDR2G04bCYXtFMjcLsw0waZkzPEpgslWpYfgIhAPrmFqTjKbpb
# J+dgJw8Vw4C2HVT36NNjGw+Rfw6MRkC2
# SIG # End signature block
