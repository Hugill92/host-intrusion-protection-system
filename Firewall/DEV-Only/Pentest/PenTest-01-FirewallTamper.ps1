[CmdletBinding()]
param(
    [ValidateSet("DEV","LIVE")]
    [string]$Mode = "DEV",
    [string]$RunStamp
)

Set-StrictMode -Version Latest
$ErrorActionPreference = "Stop"

$FirewallRoot = "C:\FirewallInstaller\Firewall"
$TestId = "PT-01-FirewallTamper"

function EnsureDir($p){ if(-not (Test-Path $p)){ New-Item $p -ItemType Directory -Force | Out-Null } }
function Now { (Get-Date).ToString("o") }

# Logs
$logDir = Join-Path $FirewallRoot "Logs\Pentest\$TestId"
EnsureDir $logDir
$logPath = Join-Path $logDir ("pentest_{0}.log" -f $RunStamp)
Start-Transcript -Path $logPath -Force | Out-Null

# Results
$state = Join-Path $FirewallRoot "State\Pentest\$TestId"
$resultsDir = Join-Path $state "results"
EnsureDir $resultsDir
$out = Join-Path $resultsDir ("pentest-results_{0}.json" -f $RunStamp)

Import-Module "$FirewallRoot\Modules\FirewallNotifications.psm1" -Force

function Notify($sev,$title,$msg){
    Send-FirewallNotification -Severity $sev -Title $title -Message $msg -Notify @("Popup","Event") -TestId $TestId
}

$start = Now
$resultObj = @{
    TestId=$TestId
    RunStamp=$RunStamp
    Mode=$Mode
    Category="Pentest"
    Controlled=$true
    StartTime=$start
    EndTime=$null
    Status=$null
    ExitCode=$null
    Evidence=@{}
    Actions=@{}
    Notifications=@{ ToastRequested=$true; EventRequested=$true }
    Artifacts=@{ Log=$logPath; Result=$out }
}

try {
    if ($Mode -ne "LIVE") {
        $resultObj.Status="SKIPPED"
        $resultObj.ExitCode=0
        $resultObj.EndTime=Now
        $resultObj | ConvertTo-Json -Depth 12 | Set-Content -Path $out -Encoding UTF8
        Stop-Transcript | Out-Null
        exit 0
    }

    Import-Module "$FirewallRoot\Modules\FirewallDetection.psm1" -Force

    $selfHeal = Join-Path $FirewallRoot "Monitor\Firewall-SelfHeal.ps1"

    $r = Get-NetFirewallRule | Where-Object { $_.DisplayName -like "WFP-*" -and $_.Enabled } | Select-Object -First 1
    if (-not $r) { throw "No enabled WFP-* rule found." }

    $before = Get-NetFirewallRule -Name $r.Name | Select DisplayName,Enabled,Action,Direction,Profile

    Notify "Critical" "PenTest starting: firewall tamper" ("Disabling protected rule: {0}" -f $before.DisplayName)

    Set-NetFirewallRule -Name $r.Name -Enabled False
    Start-Sleep -Seconds 1

    # Run self-heal
    powershell.exe -NoProfile -ExecutionPolicy Bypass -File $selfHeal | Out-Null
    Start-Sleep -Seconds 2

    $after = Get-NetFirewallRule -Name $r.Name | Select DisplayName,Enabled,Action,Direction,Profile

    # Find the latest self-heal artifact
    $healDir = Join-Path $FirewallRoot "State\SelfHeal"
    $healFile = Get-ChildItem $healDir -Filter "selfheal_*.json" -ErrorAction SilentlyContinue |
        Sort-Object LastWriteTime -Descending | Select-Object -First 1

    $healedOk = ($after.Enabled -eq $true -and $after.Action -eq "Block")

    $resultObj.Evidence = @{
        TamperedRule=$before.DisplayName
        Before=$before
        After=$after
        HealedOk=$healedOk
    }
    $resultObj.Artifacts.SelfHeal = if ($healFile) { $healFile.FullName } else { $null }

    if (-not $healedOk) {
        Notify "Critical" "PenTest FAIL: heal did not restore" ("Rule not restored to Enabled+Block: {0}" -f $before.DisplayName)
        $resultObj.Status="FAIL"
        $resultObj.ExitCode=2
        $resultObj.EndTime=Now
        $resultObj | ConvertTo-Json -Depth 14 | Set-Content -Path $out -Encoding UTF8
        Stop-Transcript | Out-Null
        exit 2
    }

    Notify "Critical" "PenTest PASS: tamper healed" ("Rule restored: {0}" -f $before.DisplayName)

    $resultObj.Status="PASS"
    $resultObj.ExitCode=0
    $resultObj.EndTime=Now
    $resultObj | ConvertTo-Json -Depth 14 | Set-Content -Path $out -Encoding UTF8
    Stop-Transcript | Out-Null
    exit 0
}
catch {
    try { Notify "Critical" "PenTest error" $_.Exception.Message } catch {}
    $resultObj.Status="FAIL"
    $resultObj.ExitCode=1
    $resultObj.EndTime=Now
    $resultObj.Evidence.Error=$_.Exception.Message
    $resultObj | ConvertTo-Json -Depth 14 | Set-Content -Path $out -Encoding UTF8
    Stop-Transcript | Out-Null
    exit 1
}

# SIG # Begin signature block
# MIIEbQYJKoZIhvcNAQcCoIIEXjCCBFoCAQExCzAJBgUrDgMCGgUAMGkGCisGAQQB
# gjcCAQSgWzBZMDQGCisGAQQBgjcCAR4wJgIDAQAABBAfzDtgWUsITrck0sYpfvNR
# AgEAAgEAAgEAAgEAAgEAMCEwCQYFKw4DAhoFAAQUAww8U2XUJGOGSWaRw0fmOltN
# 7hygggK1MIICsTCCAZmgAwIBAgIUA+POe3D7qmANSWS/liNWJ/XK6bEwDQYJKoZI
# hvcNAQELBQAwJzElMCMGA1UEAwwcRmlyZXdhbGxDb3JlIE9mZmxpbmUgUm9vdCBD
# QTAeFw0yNjAyMDMwNzU1NTdaFw0yOTAzMDkwNzU1NTdaMFgxCzAJBgNVBAYTAlVT
# MREwDwYDVQQLDAhTZWN1cml0eTEVMBMGA1UECgwMRmlyZXdhbGxDb3JlMR8wHQYD
# VQQDDBZGaXJld2FsbENvcmUgU2lnbmF0dXJlMFkwEwYHKoZIzj0CAQYIKoZIzj0D
# AQcDQgAExBZAuSDtDbNMz5nbZx6Xosv0IxskeV3H2I8fMI1YTGKMmeYMhml40QQJ
# wbEbG0i9e9pBd3TEr9tCbnzSOUpmTKNvMG0wCQYDVR0TBAIwADALBgNVHQ8EBAMC
# B4AwEwYDVR0lBAwwCgYIKwYBBQUHAwMwHQYDVR0OBBYEFKm7zYv3h0UWScu5+Z98
# 7l7v7EjsMB8GA1UdIwQYMBaAFCwozIRNrDpNuqmNvBlZruA6sHoTMA0GCSqGSIb3
# DQEBCwUAA4IBAQCbL4xxsZMbwFhgB9cYkfkjm7yymmqlcCpnt4RwF5k2rYYFlI4w
# 8B0IBaIT8u2YoNjLLtdc5UXlAhnRrtnmrGhAhXTMois32SAOPjEB0Fr/kjHJvddj
# ow7cBLQozQtP/kNQQyEj7+zgPMO0w65i5NNJkopf3+meGTZX3oHaA8ng2CvJX/vQ
# ztgEa3XUVPsGK4F3HUc4XpJAbPSKCeKn16JDr7tmb1WazxN39iIhT25rgYM3Wyf1
# XZHgqADpfg990MnXc5PCf8+1kg4lqiEhdROxmSko4EKfHPTHE3FteWJuDEfpW8p9
# /gooBjq5fPZc4TMppuq4+r0m70jJpdgBEIB9MYIBIjCCAR4CAQEwPzAnMSUwIwYD
# VQQDDBxGaXJld2FsbENvcmUgT2ZmbGluZSBSb290IENBAhQD4857cPuqYA1JZL+W
# I1Yn9crpsTAJBgUrDgMCGgUAoHgwGAYKKwYBBAGCNwIBDDEKMAigAoAAoQKAADAZ
# BgkqhkiG9w0BCQMxDAYKKwYBBAGCNwIBBDAcBgorBgEEAYI3AgELMQ4wDAYKKwYB
# BAGCNwIBFTAjBgkqhkiG9w0BCQQxFgQUHnNdYyApl0/DpIDK1b0WYRRcyUkwCwYH
# KoZIzj0CAQUABEYwRAIgfVvxHVfnynMyOf+rp4Sdp0R/l3o0xzo1wQfaihDFCj4C
# IGkJTD3QF0LDxkfC8/FwSNNIZa8bDCU4AgVRmtILT0RP
# SIG # End signature block
