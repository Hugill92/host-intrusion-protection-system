[CmdletBinding()]
param(
    [ValidateSet("DEV","LIVE")]
    [string]$Mode = "DEV",
    [string]$RunStamp
)

Set-StrictMode -Version Latest
$ErrorActionPreference = "Stop"

$FirewallRoot = "C:\FirewallInstaller\Firewall"
$TestId = "PT-03-ConfigDrift"
$Target = "C:\FirewallInstaller\Firewall\Policy\Default-Inbound.txt"

function EnsureDir($p){ if(-not (Test-Path $p)){ New-Item $p -ItemType Directory -Force | Out-Null } }
function Stamp { if($RunStamp){$RunStamp}else{(Get-Date).ToString("yyyyMMdd_HHmmss")} }
function Result([string]$s){
    $c=@{PASS="Green";FAIL="Red";SKIPPED="Yellow"}[$s]
    Write-Host "[PENTEST-RESULT] $s" -ForegroundColor $c
}
function Notify($sev,$title,$msg){
    try{
        Import-Module "$FirewallRoot\Modules\FirewallNotifications.psm1" -Force -ErrorAction Stop
        Send-FirewallNotification -Severity $sev -Title $title -Message $msg -Notify @("Event") -TestId $TestId
    } catch {}
}

$state = Join-Path $FirewallRoot "State\Pentest\$TestId"
$resultsDir = Join-Path $state "results"
EnsureDir $resultsDir
$out = Join-Path $resultsDir ("pentest-results_{0}.json" -f (Stamp))

try {
    if ($Mode -ne "LIVE") {
        @{ TestId=$TestId; Mode=$Mode; Status="SKIPPED"; Reason="LIVE-only"; Stamp=(Stamp) } |
            ConvertTo-Json -Depth 6 | Set-Content -Path $out -Encoding UTF8
        Result "SKIPPED"
        exit 0
    }

    Import-Module "$FirewallRoot\Modules\FirewallDetection.psm1" -Force

    if (-not (Test-Path $Target)) { throw "Target not found: $Target" }

    $orig = Get-Content $Target -Raw
    # benign drift: append whitespace line
    Add-Content -Path $Target -Value "" -Encoding ASCII

    Start-Sleep -Seconds 1

    $r = Invoke-FirewallBaselineDetection -FirewallRoot $FirewallRoot -BaselineMaxAgeDays 3
    $shouldNotHeal = (-not $r.MaliciousDetected)

    # restore file back exactly
    $orig | Set-Content -Path $Target -Encoding ASCII

    $payload = @{
        TestId=$TestId; Stamp=(Stamp); Mode=$Mode;
        DriftDetected=$r.DriftDetected; MaliciousDetected=$r.MaliciousDetected;
        PassCondition=$shouldNotHeal
    }

    if (-not $r.DriftDetected) {
        Notify "Warning" "Config drift test inconclusive" "Drift was not detected when expected."
        $payload.Status="FAIL"
        $payload | ConvertTo-Json -Depth 8 | Set-Content -Path $out -Encoding UTF8
        Result "FAIL"
        exit 2
    }

    if (-not $shouldNotHeal) {
        Notify "Critical" "Config drift misclassified" "Benign drift was treated as malicious."
        $payload.Status="FAIL"
        $payload | ConvertTo-Json -Depth 8 | Set-Content -Path $out -Encoding UTF8
        Result "FAIL"
        exit 2
    }

    Notify "Info" "Config drift behavior correct" "Benign drift detected without self-heal trigger."
    $payload.Status="PASS"
    $payload | ConvertTo-Json -Depth 8 | Set-Content -Path $out -Encoding UTF8
    Result "PASS"
    exit 0
}
catch {
    Notify "Critical" "PenTest error" $_.Exception.Message
    @{ TestId=$TestId; Stamp=(Stamp); Mode=$Mode; Status="FAIL"; Error=$_.Exception.Message } |
        ConvertTo-Json -Depth 6 | Set-Content -Path $out -Encoding UTF8
    Result "FAIL"
    exit 1
}

# SIG # Begin signature block
# MIIEbwYJKoZIhvcNAQcCoIIEYDCCBFwCAQExCzAJBgUrDgMCGgUAMGkGCisGAQQB
# gjcCAQSgWzBZMDQGCisGAQQBgjcCAR4wJgIDAQAABBAfzDtgWUsITrck0sYpfvNR
# AgEAAgEAAgEAAgEAAgEAMCEwCQYFKw4DAhoFAAQUwcKsIT+c+Jo2ZQtfx9bgdUMq
# luigggK1MIICsTCCAZmgAwIBAgIUA+POe3D7qmANSWS/liNWJ/XK6bEwDQYJKoZI
# hvcNAQELBQAwJzElMCMGA1UEAwwcRmlyZXdhbGxDb3JlIE9mZmxpbmUgUm9vdCBD
# QTAeFw0yNjAyMDMwNzU1NTdaFw0yOTAzMDkwNzU1NTdaMFgxCzAJBgNVBAYTAlVT
# MREwDwYDVQQLDAhTZWN1cml0eTEVMBMGA1UECgwMRmlyZXdhbGxDb3JlMR8wHQYD
# VQQDDBZGaXJld2FsbENvcmUgU2lnbmF0dXJlMFkwEwYHKoZIzj0CAQYIKoZIzj0D
# AQcDQgAExBZAuSDtDbNMz5nbZx6Xosv0IxskeV3H2I8fMI1YTGKMmeYMhml40QQJ
# wbEbG0i9e9pBd3TEr9tCbnzSOUpmTKNvMG0wCQYDVR0TBAIwADALBgNVHQ8EBAMC
# B4AwEwYDVR0lBAwwCgYIKwYBBQUHAwMwHQYDVR0OBBYEFKm7zYv3h0UWScu5+Z98
# 7l7v7EjsMB8GA1UdIwQYMBaAFCwozIRNrDpNuqmNvBlZruA6sHoTMA0GCSqGSIb3
# DQEBCwUAA4IBAQCbL4xxsZMbwFhgB9cYkfkjm7yymmqlcCpnt4RwF5k2rYYFlI4w
# 8B0IBaIT8u2YoNjLLtdc5UXlAhnRrtnmrGhAhXTMois32SAOPjEB0Fr/kjHJvddj
# ow7cBLQozQtP/kNQQyEj7+zgPMO0w65i5NNJkopf3+meGTZX3oHaA8ng2CvJX/vQ
# ztgEa3XUVPsGK4F3HUc4XpJAbPSKCeKn16JDr7tmb1WazxN39iIhT25rgYM3Wyf1
# XZHgqADpfg990MnXc5PCf8+1kg4lqiEhdROxmSko4EKfHPTHE3FteWJuDEfpW8p9
# /gooBjq5fPZc4TMppuq4+r0m70jJpdgBEIB9MYIBJDCCASACAQEwPzAnMSUwIwYD
# VQQDDBxGaXJld2FsbENvcmUgT2ZmbGluZSBSb290IENBAhQD4857cPuqYA1JZL+W
# I1Yn9crpsTAJBgUrDgMCGgUAoHgwGAYKKwYBBAGCNwIBDDEKMAigAoAAoQKAADAZ
# BgkqhkiG9w0BCQMxDAYKKwYBBAGCNwIBBDAcBgorBgEEAYI3AgELMQ4wDAYKKwYB
# BAGCNwIBFTAjBgkqhkiG9w0BCQQxFgQUZjtAyTat+rgUNewMNlcT1dZW1rAwCwYH
# KoZIzj0CAQUABEgwRgIhANXGCe8Q/SpjWz9UAtATx9KBNI0p+CsrE5oQTy+YlpVW
# AiEArac0vUnf+0vxJ9iHaeRQ9QcnigJIFdr/W3Duf9e+MNU=
# SIG # End signature block
