[CmdletBinding()]
param(
    [ValidateSet("DEV","LIVE")]
    [string]$Mode = "DEV",
    [string]$RunStamp
)

Set-StrictMode -Version Latest
$ErrorActionPreference = "Stop"

$FirewallRoot = "C:\FirewallInstaller\Firewall"
$TestId = "PT-05-BaselineMissingOrStale"
$Baseline = Join-Path $FirewallRoot "State\Baseline\baseline.sha256.json"
$selfHeal = Join-Path $FirewallRoot "Monitor\Firewall-SelfHeal.ps1"

function EnsureDir($p){ if(-not (Test-Path $p)){ New-Item $p -ItemType Directory -Force | Out-Null } }
function Stamp { if($RunStamp){$RunStamp}else{(Get-Date).ToString("yyyyMMdd_HHmmss")} }
function Result([string]$s){
    $c=@{PASS="Green";FAIL="Red";SKIPPED="Yellow"}[$s]
    Write-Host "[PENTEST-RESULT] $s" -ForegroundColor $c
}
function Notify($sev,$title,$msg){
    try{
        Import-Module "$FirewallRoot\Modules\FirewallNotifications.psm1" -Force -ErrorAction Stop
        Send-FirewallNotification -Severity $sev -Title $title -Message $msg -Notify @("Popup","Event") -TestId $TestId
    } catch {}
}

$state = Join-Path $FirewallRoot "State\Pentest\$TestId"
$resultsDir = Join-Path $state "results"
EnsureDir $resultsDir
$out = Join-Path $resultsDir ("pentest-results_{0}.json" -f (Stamp))

try {
    if ($Mode -ne "LIVE") {
        @{ TestId=$TestId; Mode=$Mode; Status="SKIPPED"; Reason="LIVE-only"; Stamp=(Stamp) } |
            ConvertTo-Json -Depth 6 | Set-Content -Path $out -Encoding UTF8
        Result "SKIPPED"
        exit 0
    }

    Import-Module "$FirewallRoot\Modules\FirewallDetection.psm1" -Force

    # Backup baseline file if present
    $backup = $null
    if (Test-Path $Baseline) {
        $backup = $Baseline + ".bak"
        Copy-Item $Baseline $backup -Force
        Remove-Item $Baseline -Force
    }

    # Weaken a protected rule
    $r = Get-NetFirewallRule | Where-Object { $_.DisplayName -like "WFP-*" -and $_.Enabled } | Select-Object -First 1
    if (-not $r) { throw "No enabled WFP-* rule found." }
    Set-NetFirewallRule -Name $r.Name -Enabled False

    Start-Sleep -Seconds 1
    $det = Invoke-FirewallBaselineDetection -FirewallRoot $FirewallRoot -BaselineMaxAgeDays 3

    # Heal should restore rule even if baseline is missing
    powershell.exe -NoProfile -ExecutionPolicy Bypass -File $selfHeal | Out-Null
    Start-Sleep -Seconds 2

    $after = Get-NetFirewallRule -Name $r.Name | Select DisplayName,Enabled,Action
    $ok = ($after.Enabled -eq $true -and $after.Action -eq "Block")

    # Restore baseline file
    if ($backup -and (Test-Path $backup)) {
        Move-Item $backup $Baseline -Force
    }

    $payload = @{
        TestId=$TestId; Stamp=(Stamp); Mode=$Mode;
        BaselineStatus=$det.BaselineStatus;
        MaliciousDetected=$det.MaliciousDetected;
        Healed=$ok
    }

    if (-not $ok) {
        Notify "Critical" "PenTest failed: heal did not restore" "Self-heal did not restore package-owned rule state."
        $payload.Status="FAIL"
        $payload | ConvertTo-Json -Depth 8 | Set-Content -Path $out -Encoding UTF8
        Result "FAIL"
        exit 2
    }

    Notify "Critical" "PenTest: missing baseline still healed" "Self-heal restored protections even with missing baseline."
    $payload.Status="PASS"
    $payload | ConvertTo-Json -Depth 8 | Set-Content -Path $out -Encoding UTF8
    Result "PASS"
    exit 0
}
catch {
    Notify "Critical" "PenTest error" $_.Exception.Message
    @{ TestId=$TestId; Stamp=(Stamp); Mode=$Mode; Status="FAIL"; Error=$_.Exception.Message } |
        ConvertTo-Json -Depth 6 | Set-Content -Path $out -Encoding UTF8
    Result "FAIL"
    exit 1
}
